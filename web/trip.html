<!DOCTYPE html>
<html>

<head>
  <meta charset="ISO-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Andrea Boni NMEARouter</title>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="js/nmearouter.js?b14"></script>
  <link href="css/nmearouter.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="nmeasail.png">
  <script>
    $.getScript("https://maps.googleapis.com/maps/api/js?key=" + getGKey(), function(data, textStatus, jqxhr) {
      console.log(data); //data returned
      console.log(textStatus); //success
      console.log(jqxhr.status); //200
      console.log('GMAP API Lodaded');
      $.getScript("js/maplabel.js", function(d, t, j) {
        console.log('GMAP Labels API Lodaded');
      });
    });


  </script>

  <style>
    /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
    #map {
      height: 100%;
    }

    .documentList {
      overflow-y: scroll;
      padding-right: 15px;
      height: 400px;
    }

    .card-router-body {
      height: 320px;
      padding: 10px;
    }

    .card-router {
      margin-bottom: 10px;
    }

    .info_cell {
      padding-bottom: 12px;
      padding-top: 6px;
      padding-right: 12px;
    }

    .chart-canvas {
      min-height: 100%;
      min-width: 100%;
    }

    #mapToolbar {
      position: absolute;
      bottom: 30px;
      left: 20px;

    }

    .tile {
      background-color: darkslategrey;
      min-width: 180px;
      height: 180px;
      width: 100%;
      margin: 5px;
      padding: 5px;
    }

    .tile_value1 {
      font-size: x-large;
      text-align: right;
    }

    .tile_value2 {
      font-size: x-large;
      text-align: right;
    }

  </style>

</head>

<script type="text/javascript">

  function getUrlVars() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars;
  }

  var tripId = getUrlVars()["trip"];
  var tripName = getUrlVars()["name"];
  var tripObject = httpGetTripAnalytics(tripId);
  var current = tripObject;
  var currentLegIx = 0;
  var pieChart;
  var speedDistrChart;
  var speedChart;

  tripObject["startT"] = Date.parse(tripObject.start);
  tripObject["endT"] = Date.parse(tripObject.end);
  tripObject.legs.forEach(element => {
    element["startT"] = Date.parse(element.start);
    element["endT"] = Date.parse(element.end);
  });
  

  app.controller("infoController", function ($scope) {
    $scope.trip = tripObject;
    $scope.current = tripObject;
    $scope.tripName = tripName;
    $scope.currentLegIx = currentLegIx;
    $scope.legLabel = "Trip";
    $scope.numberOfLegs = tripObject.legs.length;
    loadMe();
  });

  function getTime(s) {
    var t = s.split(":");
    return Math.round((t[0] * 60 * 60 + t[1] * 60 + t[2])/3600)/100;
  }

  function loadMe() {
    loadTimeChart();
    loadSpeedDistrChart();
    createSpeedChart();
  }

  function loadSpeedDistrChart() {
    var ctx = document.getElementById("speedDistrChart");
    res = [];
    resS = [];
    for (i = 0; i<current.speedDistribution.length; i++) {
      res.push(current.speedDistribution[i].distance);
    }
    for (i = 0; i<current.speedDistributionSail.length; i++) {
      resS.push(current.speedDistributionSail[i].distance);
    }
    speedDistrChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['0.5', '1.0', '1.5', '2.0', '2.5', '3.0', '3.5', '4.0', '4.5', '5.0', '5.5', '6.0',
          '6.5', '7.0', '7.5', '8.0', '8.5', '9.0', '9.5', '10.0', '10.5', '11.0', '11.5', '12.0', 
          '12.5', '13.0', '12.5', '13.0', '13.5', '14.0', '14.5', '15.0'],
        datasets: [{
          data: res,
          label: "Distance at SOG",
          backgroundColor: "orange"
        },
        {
          data: resS,
          label: "Distance at SOG (Sail)",
          backgroundColor: "blue"
        }]
      },
      options: {}
    });
  }

  function createOrFillPieChart(data, text) {
    if (pieChart==null) {
      ctx = document.getElementById("pieChart");
      pieChart = new Chart(ctx, {
        type: 'doughnut',
        data: data,
        options: {
          title: {
            display: true,
            text: text
          },
          legend: {
            position: "right"
          }
        }
      });
    } else {
      pieChart.data = data;
      pieChart.options.title.text = 'Trip Time breakdown (H)';
      pieChart.update();
    }
  }

  function loadTimeChart() {
    var data = {
      datasets: [{
          data: [getTime(tripObject.navEngineOffTime), getTime(tripObject.navEngineOn_Time), getTime(tripObject.navEngineUnkTime), getTime(tripObject.anchorTime)],
          backgroundColor: ["blue", "red", "orange", "gray"],
         
      }],
      labels: [
          'Sail',
          'Engine',
          'Unknownn',
          'Anchor'
      ]
    }
    createOrFillPieChart(data, 'Trip Time breakdown (H)');
  }

  function loadDistChart() {
    var data = {
      datasets: [{
          data: [Math.round(current.navEngineOffDist * 100)/100, 
            Math.round(current.navEngineOn_Dist * 100)/100,
            Math.round(current.navEngineUnkDist * 100)/100],
          backgroundColor: ["blue", "red", "orange"],
         
      }],
      labels: [
          'Sail',
          'Engine'
      ]
    }
    createOrFillPieChart(data, 'Leg distance breakdown (NM)');
  }

  function nextLeg() {
    do {
      currentLegIx = (currentLegIx + 1) % (tripObject.legs.length+1);
    } while (document.getElementById("L" + currentLegIx)==null);
    panel = _switchLeg();
    legList = document.getElementById("legList");
    viewHeight = legList.offsetHeight; 
    panelBottom = panel.offsetTop;
    panelTop = panel.offsetTop - panel.offsetHeight;
    viewBottom = legList.scrollTop + legList.offsetHeight;
    viewTop = legList.scrollTop;
    if (panelBottom > viewBottom) {
      legList.scrollTo(0, panelBottom - viewHeight + 30);
    } else if (panelTop < viewTop) {
      legList.scrollTo(0, panelTop);
    }
  }

  function previousLeg() {
    do {
      currentLegIx = (currentLegIx + tripObject.legs.length) % (tripObject.legs.length+1);
    } while (document.getElementById("L" + currentLegIx)==null);
    panel = _switchLeg();
    legList = document.getElementById("legList");
    viewHeight = legList.offsetHeight; 
    panelBottom = panel.offsetTop;
    panelTop = panel.offsetTop - panel.offsetHeight;
    viewBottom = legList.scrollTop + legList.offsetHeight;
    viewTop = legList.scrollTop;
    if (panelBottom > viewBottom) {
      legList.scrollTo(0, panelBottom - viewHeight + 30);
    } else if (panelTop < viewTop) {
      legList.scrollTo(0, panelTop);
    }
  }

  function getLegIx(leg) {
    return parseInt(leg.id.substring(1));
  }
  
  function switchLeg(leg){
    currentLegIx = getLegIx(leg);
    _switchLeg();
  }

  function _switchLeg() {
    for (i = 0; i<=tripObject.legs.length; i++) {
      sL = "L" + i;
      panel = document.getElementById(sL);
      if (panel!=null) {
        panel.className = "row alert alert-primary";  // Otherwise, use `second_name`
      }
    }
    panel = document.getElementById("L"+currentLegIx);
    panel.className = "row alert alert-secondary";   // Set other class name

    if (currentLegIx==0) current = tripObject;
    else current = tripObject.legs[currentLegIx-1];

    if (currentLegIx==0) {
      loadTimeChart();
    } else {
      loadDistChart();
    }

    res = []; resS = [];
    for (i = 0; i<current.speedDistribution.length; i++) { res.push(current.speedDistribution[i].distance); }
    for (i = 0; i<current.speedDistributionSail.length; i++) { resS.push(current.speedDistributionSail[i].distance); }
    speedDistrChart.data.datasets[0].data = res;
    speedDistrChart.data.datasets[1].data = resS;
    speedDistrChart.update();

    if (currentLegIx>0) {
      httpLoadSpeedDateRange(dateToYMD(new Date(current.startT)), dateToYMD(new Date(current.endT)), onFillSpeedChart);
    } else {
      resetSpeedChart();
    }

    var controllerElement = document.getElementById('nmearouter');
    var controllerScope = angular.element(controllerElement).scope();
    controllerScope.current = current;
    controllerScope.currentLegIx = currentLegIx;
    controllerScope.legLabel = (currentLegIx==0)?"Trip":("Leg " + currentLegIx);
    controllerScope.$evalAsync();

    return panel;
  }
  
  function dateToYMD(date) {
    d = date.getDate();
    m = date.getMonth() + 1; //Month from 0 to 11
    y = date.getFullYear();
    h = date.getHours();
    mm = date.getMinutes();
    return '' + y + (m<=9 ? '0' + m : m) + (d <= 9 ? '0' + d : d) + (h <= 9 ? '0' + h : h) + (mm <= 9 ? '0' + mm : mm);
  }

  function resetSpeedChart() {
    if (speedChart!=null) {
      speedChart.data.datasets = [{
        data: []
      }];
      speedChart.update();
    }
  }

  function createSpeedChart() {
    ctx = document.getElementById('speedChart');
    speedChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            data: []
          }]
        },
        options: {
          spanGaps: false,
          legend: { display: false },
          scales: { xAxes: [{ type: 'time', }] }
        }
      });

  }

  function onFillSpeedChart(speedSerie, leg) {
    speedChart.data.datasets = [
      getSerie(speedSerie, "SOG", "v",    "blue"),
      getSerie(speedSerie, "SOG", "vMin", "gray"),
      getSerie(speedSerie, "SOG", "vMax", "red")
    ];
    speedChart.update();
  }

  function getSerie(data, serie, attr, color) {
    return {
      		data: getDataPoints(data, serie, attr),
      		borderColor: color,
          pointRadius: 0,
          lineTension: 0,
          fill: false
      	};
  }

  function getDataPoints(data, name, attr) {
    var dt = [];
    var sr = data[name];
    var i;
    var lastT = 0;
    for (i = 0; i<sr.length; i++) {
      var item = sr[i];
      var t = item['time'];
      if (lastT==0 || lastT<t) {
        var datapoint = new Object();
        datapoint.x = new Date(t);
        datapoint.y = parseFloat(item[attr]);
        lastT = t;
      } else {
        console.log("Out of sync items!")
      }
      dt.push(datapoint);
    }
    return dt;
  }

  function highlight(leg, yesno){

    var panel = document.getElementById(leg);
    if (yesno) { // Check the current class name
        panel.className = "row alert alert-secondary";   // Set other class name
    } else {
        panel.className = "row alert alert-primary";  // Otherwise, use `second_name`
    }
  }

  function anKeyPress(e) {
    if (e.code=="ArrowLeft")
      previousLeg();
    else if (e.code=="ArrowRight")
      nextLeg();
  }

  document.addEventListener('keydown', anKeyPress);

  class MyTile extends HTMLElement {
    static get observedAttributes() {
      return ['title', 'value1', 'value2'];
    }
    
    get title() {
      return this.getAttribute('title');
    }

    get value1() {
      return this.getAttribute('value1');
    }

    get value2() {
      return this.getAttribute('value2');
    }

    connectedCallback() {
      this.innerHTML = "<div class='tile'>"+
        "<H2>" + this.getAttribute('title') + "</H2>" +
        "<div class='tile_value1'>" + this.getAttribute('value1') + "</div>" +
        "<div class='tile_value2'>" + this.getAttribute('value2') + "</div>" +
        "</div>";
    }
  }

  customElements.define('my-tile', MyTile);

</script>

<body ng-app="nmearouter">

<div id="nmearouter" class="container-fluid" ng-controller="infoController">
  <div class="row"><div class="col-12">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active"><a href="track.html">Track</a></li>
        <li class="breadcrumb-item active">Trip</li>
    </ol>
  </div></div>
  <div class="row">
    <div style="min-width: 500px; min-height: 500px;" class="col">
      <div class="alert alert-warning">
        <div class="col">
          <a href="" onclick="previousLeg();"><span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span></a>
          &nbsp;{{legLabel}} of {{numberOfLegs}} Legs&nbsp;<a href="" onclick="nextLeg();"><span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span></a>
          &nbsp;"{{tripName}}"
        </div>
      </div>
      <div class="documentList" id="legList">
        <div class="row alert alert-success">
          <div class="col-2">Leg</div>
          <div class="col-4">Date & time</div>
          <div class="col-3">Duration & dist</div>
          <div class="col-3">Sail dur & dist</div>
        </div>
        <div class="row alert alert-secondary" onclick="switchLeg(this)" id="L0">
          <div class="col-2">Trip</div>
          <div class="col-4">{{trip.startT | date:'dd/MM/yyyy HH:mm'}}<br>{{trip.endT | date:'dd/MM/yyyy
              HH:mm'}}
          </div>
          <div class="col-3">{{trip.navTime}}<br>{{trip.navDist | number:2}}NM<br>{{trip.speedAverage |
              number:2}}KN
          </div>
          <div class="col-3">{{trip.navEngineOffTime}}<br>{{trip.navEngineOffDist | number:2}}NM<br>{{trip.speedSailAverage
              | number:2}}KN
          </div>
        </div>
        <div class="row alert alert-primary" ng-repeat="leg in trip.legs" ng-if="leg.navDist>1.0"
              onclick="switchLeg(this)" id="L{{leg.leg}}">
          <div class="col-2">Leg {{leg.leg}}</div>
          <div class="col-4">{{leg.startT | date:'dd/MM/yy HH:mm'}}<br>{{leg.endT | date:'dd/MM/yy HH:mm'}}
          </div>
          <div class="col-3">{{leg.navTime}}<br>{{leg.navDist | number:2}}NM<br>{{leg.speedAverage |
              number:2}}KN
          </div>
          <div class="col-3">{{leg.navEngineOffTime}}<br>{{leg.navEngineOffDist | number:2}}NM<br>{{leg.speedSailAverage
              | number:2}}KN
          </div>
        </div>
      </div>
      <div style="width: 100%; background-color: darkturquoise;" class="row">
        <div style="margin: 3px;" class="col-auto"><my-tile title="Trip" value1="{{tripName}}" value2=""></my-tile></div>
        <div style="margin: 3px;" class="col-auto"><my-tile title="Dates" value1="{{current.start | date:'dd/MM/yy'}}" value2="{{current.end | date:'dd/MM/yy'}}"></my-tile></div>
        <div style="margin: 3px;" class="col-auto"><my-tile title="Times" value1="Tot {{current.totalTime}}" value2="Nav {{current.NavTime}}"></my-tile></div>
        <div style="margin: 3px;" class="col-auto"><my-tile title="Sail" value1="{{current.navEngineOffTime}}" value2="{{current.navEngineOffDist | number:2}}NM"></my-tile></div>
        <div style="margin: 3px;" class="col-auto"><my-tile title="Engine" value1="{{current.navEngineOn_Time}}" value2="{{current.navEngineOn_Dist | number:2}}NM"></my-tile></div>
      </div>
    </div>
    <div class="col">
      <div class="row">
        <div style="min-width: 300px; min-height: 300px;" class="col">
          <div>
            <canvas class="chart-canvas" id="pieChart"></canvas>
          </div>
        </div>
        <div style="min-width: 400px; min-height: 300px;" class="col">
          <div>
              <canvas class="chart-canvas" id="speedDistrChart"></canvas>
          </div>
        </div>
        <div style="min-width: 400px; min-height: 300px;" class="col">
          <div>
            <canvas class="chart-canvas" id="speedChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
</body>
</html>
