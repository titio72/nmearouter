<!DOCTYPE html>
<html>

<head>
  <meta charset="ISO-8859-1">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Andrea Boni NMEARouter</title>
  <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8"></script>
  <script src="js/nmearouter.js?b14"></script>
  <link href="css/nmearouter.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="nmeasail.png">
  <script>
    $.getScript("https://maps.googleapis.com/maps/api/js?key=" + getGKey(), function(data, textStatus, jqxhr) {
      console.log(data); //data returned
      console.log(textStatus); //success
      console.log(jqxhr.status); //200
      console.log('GMAP API Lodaded');
      $.getScript("js/maplabel.js", function(d, t, j) {
        console.log('GMAP Labels API Lodaded');
      });
    });


  </script>

  <style>
    /* Always set the map height explicitly to define the size of the div
         * element that contains the map. */
    #map {
      height: 100%;
    }

    .documentList {
      overflow-y: scroll;
      height: 400px;
      width: 100%;
      padding-right: 15px;
    }

    .card-router-body {
      height: 320px;
      padding: 10px;
    }

    .card-router {
      margin-bottom: 10px;
    }

    .info_cell {
      padding-bottom: 12px;
      padding-top: 6px;
      padding-right: 12px;
    }

    .chart-canvas {
      min-height: 100%;
      min-width: 100%;
    }

    #mapToolbar {
      position: absolute;
      bottom: 30px;
      left: 20px;

    }



  </style>

</head>

<script type="text/javascript">

  function getUrlVars() {
      var vars = {};
      var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars;
  }
  var tripId = getUrlVars()["trip"];
  var tripName = getUrlVars()["name"];
  var tripObject = httpGetTripAnalytics(tripId);
  var current = tripObject;
  var distPieChart;
  var speedDistrChart;
  var speedChart;

  tripObject["startT"] = Date.parse(tripObject.start);
  tripObject["endT"] = Date.parse(tripObject.end);
  tripObject.legs.forEach(element => {
    element["startT"] = Date.parse(element.start);
    element["endT"] = Date.parse(element.end);
  });
  

  app.controller("infoController", function ($scope) {
    $scope.trip = tripObject;
    $scope.current = tripObject;
    $scope.tripName = tripName;
    loadMe();
  });

  function getTime(s) {
    var t = s.split(":");
    return Math.round((t[0] * 60 * 60 + t[1] * 60 + t[2])/3600)/100;
  }

  function loadMe() {
    loadTimeChart();
    loadDistChart();
    loadSpeedDistrChart();
  }

  function loadSpeedDistrChart() {
    var ctx = document.getElementById("speedDistrChart");
    res = [];
    resS = [];
    for (i = 0; i<current.speedDistribution.length; i++) {
      res.push(current.speedDistribution[i].distance);
    }
    for (i = 0; i<current.speedDistributionSail.length; i++) {
      resS.push(current.speedDistributionSail[i].distance);
    }
    speedDistrChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['0.5', '1.0', '1.5', '2.0', '2.5', '3.0', '3.5', '4.0', '4.5', '5.0', '5.5', '6.0',
          '6.5', '7.0', '7.5', '8.0', '8.5', '9.0', '9.5', '10.0', '10.5', '11.0', '11.5', '12.0', 
          '12.5', '13.0', '12.5', '13.0', '13.5', '14.0', '14.5', '15.0'],
        datasets: [{
          data: res,
          label: "Distance at SOG",
          backgroundColor: "orange"
        },
        {
          data: resS,
          label: "Distance at SOG (Sail)",
          backgroundColor: "blue"
        }]
      },
      options: {}
    });
  }


  function loadTimeChart() {
    var data = {
      datasets: [{
          data: [getTime(tripObject.navEngineOffTime), getTime(tripObject.navEngineOn_Time), getTime(tripObject.navEngineUnkTime), getTime(tripObject.anchorTime)],
          backgroundColor: ["blue", "red", "orange", "gray"],
         
      }],
      labels: [
          'Sail',
          'Engine',
          'Unknownn',
          'Anchor'
      ]
    }
    var ctx = document.getElementById("durationChart");
    var myDoughnutChart = new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: {
        title: {
          display: true,
          text: 'Trip Time breakdown (H)'
        },
        legend: {
          position: "right"
        }

      }
    });
  }

  function loadDistChart() {
    var data = {
      datasets: [{
          data: [Math.round(current.navEngineOffDist * 100)/100, 
            Math.round(current.navEngineOn_Dist * 100)/100,
            Math.round(current.navEngineUnkDist * 100)/100],
          backgroundColor: ["blue", "red", "orange"],
         
      }],
      labels: [
          'Sail',
          'Engine'
      ]
    }
    var ctx = document.getElementById("distanceChart");
    distPieChart = new Chart(ctx, {
      type: 'doughnut',
      data: data,
      options: {
        title: {
          display: true,
          text: 'Leg distance breakdown (NM)'
        },
        legend: {
          display: false
        }
      }
    });
  }

  function switchLeg(leg){
    iLeg = 0;
    for (i = 0; i<=tripObject.legs.length; i++) {
      sL = "L" + i;
      panel = document.getElementById(sL);
        if (panel!=null) {
        panel.className = "row alert alert-primary";  // Otherwise, use `second_name`
      }
      if (sL==leg.id) iLeg = i;
    }
    panel = leg;
    panel.className = "row alert alert-secondary";   // Set other class name
    if (iLeg==0) current = tripObject;
    else current = tripObject.legs[iLeg-1];

    distPieChart.data.datasets[0].data[0] = Math.round(current.navEngineOffDist * 100)/100;
    distPieChart.data.datasets[0].data[1] = Math.round(current.navEngineOn_Dist * 100)/100;
    distPieChart.data.datasets[0].data[2] = Math.round(current.navEngineUnkDist * 100)/100;
    distPieChart.update();

    res = []; resS = [];
    for (i = 0; i<current.speedDistribution.length; i++) { res.push(current.speedDistribution[i].distance); }
    for (i = 0; i<current.speedDistributionSail.length; i++) { resS.push(current.speedDistributionSail[i].distance); }
    speedDistrChart.data.datasets[0].data = res;
    speedDistrChart.data.datasets[1].data = resS;
    speedDistrChart.update();

    if (iLeg>0) {
      httpLoadSpeedDateRange(dateToYMD(new Date(current.startT)), dateToYMD(new Date(current.endT)), onFillSpeedChart);
    } else {
      resetSpeedChart();
    }

    var controllerElement = document.getElementById('nmearouter');
    var controllerScope = angular.element(controllerElement).scope();
    controllerScope.current = current;
    controllerScope.$evalAsync();
  }
  
  function dateToYMD(date) {
    d = date.getDate();
    m = date.getMonth() + 1; //Month from 0 to 11
    y = date.getFullYear();
    h = date.getHours();
    mm = date.getMinutes();
    return '' + y + (m<=9 ? '0' + m : m) + (d <= 9 ? '0' + d : d) + (h <= 9 ? '0' + h : h) + (mm <= 9 ? '0' + mm : mm);
  }

  function resetSpeedChart() {
    if (speedChart!=null) {
      speedChart.data.datasets = [{
        data: []
      }];
      speedChart.update();
    }
  }

  function onFillSpeedChart(speedSerie, leg) {
    var ctx = document.getElementById("speedChart");
    if (speedChart==null) {
      var datasets = [];
      datasets.push(getSerie(speedSerie, "SOG", "v",    "#22FF22"));
      datasets.push(getSerie(speedSerie, "SOG", "vMin", "#777777"));
      datasets.push(getSerie(speedSerie, "SOG", "vMax", "#FF2222"));
      speedChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: datasets
        },
        options: {
          spanGaps: false,
          legend: { display: false },
          scales: { xAxes: [{ type: 'time', }] }
        }
      });
    } else {
      speedChart.data.datasets = [
        getSerie(speedSerie, "SOG", "v",    "#22FF22"),
        getSerie(speedSerie, "SOG", "vMin", "#777777"),
        getSerie(speedSerie, "SOG", "vMax", "#FF2222")
      ];
      speedChart.update();
    }
  }

  function getSerie(data, serie, attr, color) {
    return {
      		data: getDataPoints(data, serie, attr),
      		borderColor: color,
          pointRadius: 0,
          lineTension: 0,
          fill: false
      	};
  }

  function getDataPoints(data, name, attr) {
    var dt = [];
    var sr = data[name];
    var i;
    var lastT = 0;
    for (i = 0; i<sr.length; i++) {
      var item = sr[i];
      var t = item['time'];
      if (lastT==0 || lastT<t) {
        var datapoint = new Object();
        datapoint.x = new Date(t);
        datapoint.y = parseFloat(item[attr]);
        lastT = t;
      } else {
        console.log("Out of sync items!")
      }
      dt.push(datapoint);
    }
    return dt;
  }

  function highlight(leg, yesno){

    var panel = document.getElementById(leg);
    if (yesno) { // Check the current class name
        panel.className = "row alert alert-secondary";   // Set other class name
    } else {
        panel.className = "row alert alert-primary";  // Otherwise, use `second_name`
    }
  }
</script>

<body ng-app="nmearouter">

<div id="nmearouter" class="container-fluid" ng-controller="infoController">
    <ol class="breadcrumb">
      <div class="row">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item active"><a href="track.html">Track</a></li>
        <li class="breadcrumb-item active">Trip</li>
    </ol>
    <div class="row">
        <div style="min-width: 500px;" class="col-5" id="legList">
            <div class="documentList">
                <div class="row alert alert-success">
                    <div class="col-2">Leg</div>
                    <div class="col-4">Date & time</div>
                    <div class="col-3">Duration & dist</div>
                    <div class="col-3">Sail dur & dist</div>
                </div>
                <div class="row alert alert-secondary" onclick="switchLeg(this)" id="L0">
                    <div class="col-2">Trip</div>
                    <div class="col-4">{{trip.startT | date:'dd/MM/yyyy HH:mm'}}<br>{{trip.endT | date:'dd/MM/yyyy
                        HH:mm'}}
                    </div>
                    <div class="col-3">{{trip.navTime}}<br>{{trip.navDist | number:2}}NM<br>{{trip.speedAverage |
                        number:2}}KN
                    </div>
                    <div class="col-3">{{trip.navEngineOffTime}}<br>{{trip.navEngineOffDist | number:2}}NM<br>{{trip.speedSailAverage
                        | number:2}}KN
                    </div>
                </div>
                <div class="row alert alert-primary" ng-repeat="leg in trip.legs" ng-if="leg.navDist>1.0"
                     onclick="switchLeg(this)" id="L{{leg.leg}}">
                    <div class="col-2">Leg {{leg.leg}}</div>
                    <div class="col-4">{{leg.startT | date:'dd/MM/yy HH:mm'}}<br>{{leg.endT | date:'dd/MM/yy HH:mm'}}
                    </div>
                    <div class="col-3">{{leg.navTime}}<br>{{leg.navDist | number:2}}NM<br>{{leg.speedAverage |
                        number:2}}KN
                    </div>
                    <div class="col-3">{{leg.navEngineOffTime}}<br>{{leg.navEngineOffDist | number:2}}NM<br>{{leg.speedSailAverage
                        | number:2}}KN
                    </div>
                </div>
            </div>
            <div id="">
                <canvas class="chart-canvas" id="durationChart"></canvas>
            </div>
        </div>
        <div style="min-width: 500px;" class="col-7">
            <div class="row">
                <div class="col-5">
                    <div>
                        <canvas class="chart-canvas" id="distanceChart"></canvas>
                    </div>
                </div>
                <div class="col-7">
                    <div>
                        <canvas class="chart-canvas" id="speedDistrChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <div>
                        <canvas class="chart-canvas" id="speedChart"></canvas>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-6">
                    <table>
                        <tr>
                            <td width="40%">Trip</td>
                            <td width="60%" colspan="2" style="text-align: right;">{{tripName}}
                            </td>
                        </tr>
                        <tr>
                            <td width="40%">Start</td>
                            <td width="60%" colspan="2" style="text-align: right;">{{current.start | date:'dd/MM/yyyy
                                HH:mm'}}
                            </td>
                        </tr>
                        <tr>
                            <td>End</td>
                            <td colspan="2" style="text-align: right;">{{current.end | date:'dd/MM/yyyy HH:mm'}}</td>
                        </tr>
                        <tr>
                            <td>Total Time</td>
                            <td style="text-align: right;">{{current.totalTime}}</td>
                            <td style="text-align: right;">&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Anchor Time</td>
                            <td style="text-align: right;">{{current.anchorTime}}</td>
                            <td style="text-align: right;">&nbsp;</td>
                        </tr>
                        <tr>
                            <td>Navigation Time</td>
                            <td style="text-align: right;">{{current.navTime}}</td>
                            <td style="text-align: right;">{{current.navDist | number:2}}NM</td>
                        </tr>
                    </table>
                </div>
                <div class="col-6">
                    <table>
                        <tr>
                            <td>Sail Time</td>
                            <td style="text-align: right;">{{current.navEngineOffTime}}</td>
                            <td style="text-align: right;">{{current.navEngineOffDist | number:2}}NM</td>
                        </tr>
                        <tr>
                            <td>Engine Time</td>
                            <td style="text-align: right;">{{current.navEngineOn_Time}}</td>
                            <td style="text-align: right;">{{current.navEngineOn_Dist | number:2}}NM</td>
                        </tr>
                        <tr>
                            <td>Average Speed</td>
                            <td style="text-align: right;">{{current.speedAverage | number:2}}KN</td>
                            <td style="text-align: right;">&nbsp;</td>
                        </tr>
                    </table>
                </div>
            </div>
      </div>
    </div>
          <!--
          {
            "max05NMSpeed": 8.241454566666663,
            "maxAvgSpeed": 8.5121976,
            -"navTime": "16:01:39",
            "navEngineUnkDist": 0,
            -"navEngineOn_Dist": 2.4372826500000007,
            "anchorTime": "17:30:00",
            "maxSampledSpeedTime": "2020-02-09T08:35:07Z",
            -"end": "2020-02-09T15:21:37Z",
            -"navEngineOffDist": 84.58018385000005,
            "max10NMSpeedTime1": "2020-02-09T09:07:07Z",
            "max10NMSpeedTime0": "2020-02-09T07:53:07Z",
            "navEngineUnkTime": "0:00:00",
            "maxSampledSpeed": 8.51,
            -"navEngineOffTime": "14:31:30",
            -"totalTime": "33:31:39",
            -"start": "2020-02-08T05:49:58Z",
            "max01NMSpeedTime0": "2020-02-09T08:28:37Z",
            "max01NMSpeedTime1": "2020-02-09T08:35:07Z",
            "maxSpeed": 10.42,
            "samples": 1916,
            "max05NMSpeedTime0": "2020-02-09T08:13:37Z",
            "max05NMSpeedTime1": "2020-02-09T08:49:37Z",
            "maxSpeedTime": "2020-02-09T08:43:07Z",
            "max01NMSpeed": 8.940611907692304,
            "maxAvgSpeedTime": "2020-02-09T08:35:07Z",
            -"navDist": 87.01746650000001,
            -"navEngineOn_Time": "1:30:09",
            "max10NMSpeed": 8.08690639459459,
            "legs": [
             {
              "max05NMSpeed": 7.40482687407407,
              "maxAvgSpeed": 7.9457352000000006,
              "navTime": "9:00:55",
              "navEngineUnkDist": 0,
              "navEngineOn_Dist": 1.26167104,
              "leg": 1,
              "maxSampledSpeedTime": "2020-02-08T06:19:23Z",
              "end": "2020-02-08T14:50:53Z",
              "navEngineOffDist": 42.52922850000003,
              "max10NMSpeedTime1": "2020-02-08T07:45:53Z",
              "max10NMSpeedTime0": "2020-02-08T06:17:53Z",
              "navEngineUnkTime": "0:00:00",
              "maxSampledSpeed": 7.95,
              "navEngineOffTime": "8:10:30",
              "start": "2020-02-08T06:07:23Z",
              "max01NMSpeedTime0": "2020-02-08T06:41:53Z",
              "max01NMSpeedTime1": "2020-02-08T06:48:53Z",
              "maxSpeed": 8.36,
              "samples": 1048,
              "max05NMSpeedTime0": "2020-02-08T06:24:53Z",
              "max05NMSpeedTime1": "2020-02-08T07:05:23Z",
              "maxSpeedTime": "2020-02-08T06:19:23Z",
              "max01NMSpeed": 8.067878400000001,
              "maxAvgSpeedTime": "2020-02-08T06:19:23Z",
              "navDist": 43.79089954000004,
              "navEngineOn_Time": "0:50:25",
              "max10NMSpeed": 6.801464843181818
             },
             {
              "max05NMSpeed": 8.241454566666668,
              "maxAvgSpeed": 8.5121976,
              "navTime": "7:00:44",
              "navEngineUnkDist": 0,
              "navEngineOn_Dist": 1.1756116099999998,
              "leg": 2,
              "maxSampledSpeedTime": "2020-02-09T08:35:07Z",
              "end": "2020-02-09T13:51:37Z",
              "navEngineOffDist": 42.05095534999999,
              "max10NMSpeedTime1": "2020-02-09T09:07:07Z",
              "max10NMSpeedTime0": "2020-02-09T07:53:07Z",
              "navEngineUnkTime": "0:00:00",
              "maxSampledSpeed": 8.51,
              "navEngineOffTime": "6:21:00",
              "start": "2020-02-09T06:56:07Z",
              "max01NMSpeedTime0": "2020-02-09T08:28:37Z",
              "max01NMSpeedTime1": "2020-02-09T08:35:07Z",
              "maxSpeed": 10.42,
              "samples": 832,
              "max05NMSpeedTime0": "2020-02-09T08:13:37Z",
              "max05NMSpeedTime1": "2020-02-09T08:49:37Z",
              "maxSpeedTime": "2020-02-09T08:43:07Z",
              "max01NMSpeed": 8.9406119076923,
              "maxAvgSpeedTime": "2020-02-09T08:35:07Z",
              "navDist": 43.22656696,
              "navEngineOn_Time": "0:39:44",
              "max10NMSpeed": 8.08690639459459
             }
            ],


           }
          -->
  </div>
</body>
</html>
