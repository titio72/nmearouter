<!DOCTYPE html>
<html>
<head>
    <meta charset="ISO-8859-1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Andrea Boni NMEARouter</title>
	<script src="js/nmearouter.js?G"></script>
	<style>
	/* The Modal (background) */
	.modal {
		display: none; /* Hidden by default */
		position: fixed; /* Stay in place */
		z-index: 1; /* Sit on top */
		padding-top: 100px; /* Location of the box */
		left: 0;
		top: 0;
		width: 100%; /* Full width */
		height: 100%; /* Full height */
		overflow: auto; /* Enable scroll if needed */
		background-color: rgb(0, 0, 0); /* Fallback color */
		background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
	}
	
	.darkb {
		background-color: darkgray;
	}
	
	/* Modal Content */
	.modal-content {
		background-color: #fefefe;
		margin: auto;
		padding: 20px;
		border: 1px solid #888;
		width: 50%;
	}
	
	.agentPanel {
	    padding: 10px;
	}
	
	table, tr, td {
        padding-left: 3px;
	}
	
	</style>

</head>
<script type="text/javascript">


	var agentList = httpGetAgents();
	var msg = "-";
	setColors(agentList);
	agentList.sort(compare);

	var filterDlg = document.getElementById('filterDialog');
	var closeBtn = document.getElementById('closeFilterDialog');

	app.controller("myCtrl", function($scope, $sce) {
		$scope.agents = agentList
		$scope.message = msg;
		$scope.to_trusted = function(html_code) {
		    return $sce.trustAsHtml(html_code);
		}
	});

	function setColors(agentList) {
		for (var i = 0; i < agentList.length; i++) {
			var a = agentList[i];
			if (a.started == 'false')
				a.color = "#222222";
			else
				a.color = "#33AA33";
		}
	}

	function compare(a, b) {
		if (a.builtin == "true" && b.builtin == "false")
			return 1
		else if (a.builtin == "false" && b.builtin == "true")
			return -1;
		else {
			if (a.agent < b.agent)
				return -1;
			else if (a.agent > b.agent)
				return 1;
			else
				return 0;
		}
	}
	
	
	function showFilter(a, inout) {
		document.getElementById("filterDialogLabel").innerHTML = "Filter for "
				+ a.name + " [" + inout + "]";
		document.getElementById("agent").value = a.name;

		for (var i = 0; i < agentList.length; i++) {
			if (a.name == agentList[i].agent) {
				document.getElementById("inout").value = inout;
				if (("out" == inout && "true" == agentList[i].hasFilterOut)
						|| ("in" == inout && "true" == agentList[i].hasFilterIn)) {
					var x = ("out" == inout) ? agentList[i].filterOut
							: agentList[i].filterIn;
					var ss = "";
					for (var j = 0; j < x.filters.length; j++) {
						if (j != 0)
							ss += ",";
						ss += x.filters[j].sentence;
						if (x.filters[j].source!=null && x.filters[j].source!="") {
						  ss += "@" + x.filters[j].source;
						}
					}
					document.getElementById("sentences").value = ss;
					document.getElementById("filtertype").selectedIndex = (x.type == "whitelist") ? 1: 0;
				} else {
					document.getElementById("sentences").value = "";
					document.getElementById("filtertype").selectedIndex = 0;
				}
			}
		}

		filterDialog.style.display = "block";
	}

	function hideFilter() {
		filterDialog.style.display = "none";
	}

	function commitFilter() {
		hideFilter();
		updateFilter(document.getElementById("agent").value, document
				.getElementById("inout").value, document
				.getElementById("sentences").value, document
				.getElementById("filtertype").selectedIndex == 0 ? "blacklist"
				: "whitelist");

	}

	function updateFilter(agent, inout, sentences, tp) {
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.open("GET", "http://" + window.location.hostname
				+ ":1112/filter" + inout + "?agent=" + agent + "&sentences="
				+ sentences + "&type=" + tp, true);
		xmlHttp.setRequestHeader('Content-Type', 'text/plain');
		xmlHttp.onreadystatechange = function() {
		    if (xmlHttp.readyState == XMLHttpRequest.DONE) {
		        var json = JSON.parse(xmlHttp.responseText);
		        agentList = json.agents;
		        var msg = json.message;
		        var controllerElement = document.getElementById('nmearouter');
		        var controllerScope = angular.element(controllerElement).scope();
		        setColors(agentList);
		        agentList.sort(compare);
		        controllerScope.agents = agentList;
		        controllerScope.message = msg;
		        controllerScope.$evalAsync();
		    }
		}
		xmlHttp.send(null);
	}


	function httpGetSyn(a, active) {
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.open("GET", "http://" + window.location.hostname
				+ ":1112/agentsj?agent=" + a.name + "&active=" + active, true);
		xmlHttp.setRequestHeader('Content-Type', 'text/plain');
        xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState == XMLHttpRequest.DONE) {
                var json = JSON.parse(xmlHttp.responseText);
                agentList = json.agents;
                var msg = json.message;
                var controllerElement = document.getElementById('nmearouter');
                var controllerScope = angular.element(controllerElement).scope();
                setColors(agentList);
                agentList.sort(compare);
                controllerScope.agents = agentList;
                controllerScope.message = msg;
                controllerScope.$evalAsync();
            }
        }
		
		xmlHttp.send(null);
	}

	function httpGetSynAuto(a, auto) {
		var xmlHttp = new XMLHttpRequest();
		xmlHttp.open("GET", "http://" + window.location.hostname
				+ ":1112/agentsj?agent=" + a.name + "&auto=" + auto, true);
		xmlHttp.setRequestHeader('Content-Type', 'text/plain');
        xmlHttp.onreadystatechange = function() {
            if (xmlHttp.readyState == XMLHttpRequest.DONE) {
                var json = JSON.parse(xmlHttp.responseText);
                agentList = json.agents;
                var msg = json.message;
                var controllerElement = document.getElementById('nmearouter');
                var controllerScope = angular.element(controllerElement).scope();
                setColors(agentList);
                agentList.sort(compare);
                controllerScope.agents = agentList;
                controllerScope.message = msg;
                controllerScope.$evalAsync();
            }
        }
		xmlHttp.send(null);
	}
</script>

<body ng-app="nmearouter">

	<div id="nmearouter" class="container-fluid" ng-controller="myCtrl">
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="index.html">Home</a></li>
			<li class="breadcrumb-item active">Agents</li>
		</ol>
		<div class="row" ng-repeat="a in agents" >
			<div class="col-lg-12"  style="min-width: 400px">
				<div class="panel">
					<div class="panel-body">
						<div class="col-lg-4 col-md-5 col-sm-7 col-xs-6">
                            <span ng-if="a.builtin=='false'" class="glyphicon glyphicon glyphicon-user" style="color: {{a.color}}" aria-hidden="true"></span>
                            <span ng-if="a.builtin=='true'" class="glyphicon glyphicon glyphicon-cog" style="color: {{a.color}}" aria-hidden="true"></span>
    						{{a.agent}} ({{a.type}})
						</div>
						<div class="col-lg-2 col-md-3 col-sm-5 col-xs-6" style="min-width:150px">
							<table style="float: right">
								<tr>
									<td>
										<div ng-if="a.source=='true'">
											<div ng-if="a.hasFilterIn=='true'">
												<button name={{a.agent}} type="button" class="btn darkb btn-xs" onclick='showFilter(this, "in")'>
													<span class="glyphicon glyphicon glyphicon-filter" style="color: blue" aria-hidden="true"/><span class="glyphicon glyphicon glyphicon-arrow-left" style="color: blue" aria-hidden="true"/>
												</button>
											</div>
											<div ng-if="a.hasFilterIn=='false'">
												<button name={{a.agent}} type="button" class="btn darkb btn-xs" onclick='showFilter(this, "in")'>
													<span class="glyphicon glyphicon glyphicon-filter" aria-hidden="true"/><span class="glyphicon glyphicon glyphicon-arrow-left" aria-hidden="true"/>
												</button>
											</div>
										</div>
										<div ng-if="a.source=='false'">
											<button name={{a.agent}} type="button" class="btn darkb btn-xs">
												<span class="glyphicon glyphicon-ban-circle" aria-hidden="true"/><span class="glyphicon glyphicon glyphicon-arrow-left" aria-hidden="true"/>
											</button>
										</div>
									</td>
									<td align="right">
										<div ng-if="a.target=='true'">
											<div ng-if="a.hasFilterOut=='true'">
												<button name={{a.agent}} type="button" class="btn darkb btn-xs" onclick='showFilter(this, "out")'>
													<span class="glyphicon glyphicon glyphicon-filter" style="color: blue" aria-hidden="true"/><span class="glyphicon glyphicon glyphicon-arrow-right" style="color: blue" aria-hidden="true"/>
												</button>
											</div>
											<div ng-if="a.hasFilterOut=='false'">
												<button name={{a.agent}} type="button" class="btn darkb btn-xs" onclick='showFilter(this, "out")'>
													<span class="glyphicon glyphicon glyphicon-filter" aria-hidden="true"/><span class="glyphicon glyphicon glyphicon-arrow-right" aria-hidden="true"/>
												</button>
											</div>
										</div>
										<div ng-if="a.target=='false'">
											<button name={{a.agent}} type="button" class="btn darkb btn-xs">
												<span class="glyphicon glyphicon-ban-circle" aria-hidden="true"/><span class="glyphicon glyphicon glyphicon-arrow-right" aria-hidden="true"/>
											</button>
										</div>
									</td>
									<td align="right">
										<div ng-if="a.startStop=='true' && a.builtin=='false'">
											<div ng-if="a.auto=='false'">
												<button name={{a.agent}} type="button"
													class="btn darkb btn-xs" onclick="httpGetSynAuto(this, 1)">
													<span class="glyphicon glyphicon-pushpin" aria-hidden="true" />
												</button>
											</div>
											<div ng-if="a.auto=='true'">
												<button name={{a.agent}} type="button"
													class="btn darkb btn-xs" onclick="httpGetSynAuto(this, 0)">
													<span class="glyphicon glyphicon-pushpin"
														style="color: blue" aria-hidden="true" />
												</button>
											</div>
										</div>
										<div ng-if="a.startStop=='false' || a.builtin=='true'">
											<button name={{a.agent}} type="button" class="btn darkb btn-xs">
												<span class="glyphicon glyphicon-ban-circle" aria-hidden="true"/>
											</button>
										</div>
									</td>
									<td align="right">
										<div ng-if="a.startStop=='true'">
											<div ng-if="a.started=='false'">
												<button name={{a.agent}} type="button"
													class="btn darkb btn-xs" onclick="httpGetSyn(this, 1)">
													<span class="glyphicon glyphicon-play" aria-hidden="true"></span>
												</button>
											</div>
											<div ng-if="a.started=='true'">
												<button name={{a.agent}} type="button"
													class="btn darkb btn-xs" onclick="httpGetSyn(this, 0)">
													<span class="glyphicon glyphicon-stop" style="color: blue"
														aria-hidden="true"></span>
												</button>
											</div>
										</div>
										<div ng-if="a.startStop=='false'">
											<button name={{a.agent}} type="button" class="btn darkb btn-xs">
												<span class="glyphicon glyphicon-ban-circle" aria-hidden="true"/>
											</button>
										</div>
									</td>
								</tr>
							</table>
						</div>
						<div class="col-lg-6 col-md-4 col-sm-12 col-xs-12" ng-bind-html="to_trusted(a.description)"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div id="myModal" class="modal">
		<div class="modal-content">
			<span class="close">&times;</span>
			<p>Some text in the Modal..</p>
		</div>

	</div>

	<div id="filterDialog" class="modal">
		<div class="modal-content">
			<div class="panel panel-primary">
				<div class="panel-heading">
					<h3 class="panel-title" id="filterDialogLabel">Filters for xyz</h3>
				</div>
				<div class="panel-body">
					<form>
						<input type="hidden" id="agent" /> <input type="hidden" id="inout" />
						<div class="form-group">
							<label for="sentences">Sentence list (comma separated):</label> <input
								type="text" class="form-control" id="sentences">
						</div>
						<div class="form-group">
							<label for="exampleSelect2">Filter type:</label> <select
								class="form-control" id="filtertype">
								<option>Blacklist</option>
								<option>Whitelist</option>
							</select>
						</div>
						<button type="reset" class="btn darkb btn-secondary"
							onClick="hideFilter()">Cancel</button>
						<button type="submit" class="btn darkb btn-primary"
							onClick="commitFilter()">Ok</button>
					</form>
				</div>
			</div>
		</div>
	</div>
</body>
</html>