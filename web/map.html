<!DOCTYPE html>
<html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Andrea Boni NMEARouter</title>
  <link rel="icon" type="image/png" href="nmeasail.png">
  <script src="js/nmearouter.js?l"></script>
  <!--script src="https://maps.googleapis.com/maps/api/js?v=3.36&key=AIzaSyB923F46BW5wnvAKd0pztCa37YCUx64ARo" async
    defer></script-->
  <script type="text/javascript" 
    src="http://maps.googleapis.com/maps/api/js?libraries=geometry&key=AIzaSyB923F46BW5wnvAKd0pztCa37YCUx64ARo"> 
  </script>
  <script src="js/maplabel-compiled.js"></script>
  <style>
    .panelTable {
      width: 100%;
      font-family: monospace;
      font-size: 17pt;
    }

    .panelText {
      font-family: monospace;
      font-size: 18pt;
    }

    .panelTextSmall {
      font-family: monospace;
      font-size: 12pt;
    }

    .panelRouter {
      height: 300px;
    }
  </style>
</head>
<script type="text/javascript">

  var heading;
  var speed;
  var map;
  var marker;
  var markerTo;
  var markerWind;
  var poly;
  var polyWind;
  var absoluteWind;
  var trueWind;
  var mapVectorLabel;
  var mapWindLabel;

  app.controller("myCtrl", function ($scope) {
    $scope.V0 = { value: 0.0 };
    $scope.V1 = { value: 0.0 };
  });


  var socket = null;
  $(document).ready(function () {
    window.setInterval(checkConnection, 1000);
  });

  function checkConnection() {
    if (!socket) {
      resetConnection();
    } else if (socket.readyState >= 2) {
      resetConnection();
    }
  }

  function resetConnection() {
    if (socket && socket.readyState < 2 /*OPEN or OPENING*/) {
      socket.close();
    }
    socket = new WebSocket("ws://" + window.location.hostname + ":1112/events");
    socket.onmessage = function (event) {
      processEvent(event);
    }
    socket.onclose = function (event) {
      socketClosed(event);
    }
  }

  function socketClosed(event) {
  }

  function processEvent(event) {
    var msg = JSON.parse(event.data);
    if (msg.topic == 'RMC') {
      setMarker(msg, msg.dec_latitude, msg.dec_longitude, msg.SOG, msg.COG);
      var controllerElement = document.getElementById('sensorPanel');
      var controllerScope = angular.element(controllerElement).scope();
      msg.s_dir = direction(msg.COG);
      msg.s_time = new Date(Date.parse(msg.UTC)).toLocaleTimeString();
      controllerScope['rmc'] = msg;
      controllerScope.$evalAsync();
    } else if (msg.topic == 'VHW') {
      var controllerElement = document.getElementById('sensorPanel');
      var controllerScope = angular.element(controllerElement).scope();
      msg.s_dir = direction(msg.mag_angle);
      speed = msg.speed;
      controllerScope['vector'] = msg;
      controllerScope.$evalAsync();
    } else if (msg.topic == 'MWV_R') {
      var controllerElement = document.getElementById('sensorPanel');
      var controllerScope = angular.element(controllerElement).scope();
      controllerScope['wind_r'] = msg;
      if (msg.angle > 180) {
        msg.show_angle = 360 - msg.angle;
        msg.tack = "Port"
      } else {
        msg.show_angle = msg.angle;
        msg.tack = "Starboard"
      }

      trueWind = calcTrueWind(speed, msg.angle, msg.speed);
      if (trueWind.angle > 180) {
        trueWind.show_angle = 360 - msg.angle;
        trueWind.tack = "Port"
      } else {
        trueWind.show_angle = msg.angle;
        trueWind.tack = "Starboard"
      }
      controllerScope['wind_t'] = trueWind;
      
      absoluteWind = {
        mag_angle: (heading + trueWind.angle) % 360,
        speed: trueWind.speed
      };
      controllerScope['wind'] = absoluteWind;
      
      controllerScope.$evalAsync();
    } else if (msg.topic == 'HDG') {
      var controllerElement = document.getElementById('sensorPanel');
      var controllerScope = angular.element(controllerElement).scope();
      msg.s_dir = direction(msg.angle);
      heading = msg.angle;
      controllerScope['hdg'] = msg;
      controllerScope.$evalAsync();
    }
  }

  function calcTrueWind(speed, appWindDeg, appWindSpeed) {
    v = speed;
    w = appWindSpeed;
    wA = appWindDeg / 180.0 * Math.PI;

    wAx = w * Math.sin(wA);
    wAy = w * Math.cos(wA);

    wTx = wAx;
    wTy = wAy - v;

    var r = {
      angle: 180.0 * ((Math.PI / 2) - Math.atan2(wTy, wTx)) / Math.PI,
      speed: Math.sqrt(wTx * wTx + wTy * wTy)
    }

    r.angle = r.angle % 360;
    if (r.angle<0) r.angle = 360 + r.angle; 



    return r;
  }

  function loadMap(msg, lat, lon) {
    map = new google.maps.Map(document.getElementById('map'), {
      mapTypeId: 'terrain',
      disableDefaultUI: true
    });
    var markerPos = { lat: lat, lng: lon };
    map.setCenter(markerPos);

    var bounds = new google.maps.LatLngBounds();
    var nw = { lat: markerPos.lat - 0.1, lng: markerPos.lng + 0.1 };
    var se = { lat: markerPos.lat + 0.1, lng: markerPos.lng - 0.1 };
    bounds.extend(nw);
    bounds.extend(se);
    map.fitBounds(bounds);

  }

  var iconA = {
      path: 'M -5 -10 L 0 0 L 5 -10Z',
      strokeColor: '#FF0000',
      fillColor: '#FF0000',
      fillOpacity: .6,
      anchor: new google.maps.Point(0,0),
      strokeWeight: 3,
      scale: 1
  }

  var icon = {
      path: 'M-10,0a10,10 0 1,0 20,0a10,10 0 1,0 -20,0',
      fillColor: '#FF0000',
      fillOpacity: .6,
      anchor: new google.maps.Point(0,0),
      strokeWeight: 0,
      scale: 1
  }
  var iconHere = {
      path: 'M-20,0a20,20 0 1,0 40,0a20,20 0 1,0 -40,0',
      fillColor: '#00FF00',
      fillOpacity: .6,
      anchor: new google.maps.Point(0,0),
      strokeWeight: 0,
      scale: 1
  }

  function setMarkerPos(p, cog, sog) {
    if (map!=null) {
      if (marker != null) {
        marker.setPosition(p);

        if (trueWind==null)
          marker.title = 'Vect ' + sog + 'Kn ' + cog + '\u00B0';
        else 
          marker.title = 'Vect ' + sog + 'Kn ' + cog + '\u00B0 \nWind ' + (trueWind.speed.toFixed(1) + 'Kn ' + trueWind.angle.toFixed(0) + '\u00B0');
      } else {
        marker = new google.maps.Marker({
          position: p,
          title: sog + 'Kn ' + cog + '\u00B0',
          icon: icon,
          map: map
        });
      }
    }
  }

  function setMarkerSpeed(p1, cog, sog) {
    if (map!=null) {
      var icon = {
            path: 'M -5 10 L 0 0 L 5 10Z',
              strokeColor: '#FF0000',
              fillColor: '#FF0000',
              fillOpacity: .6,
              anchor: new google.maps.Point(0,0),
              strokeWeight: 3,
              scale: 1,
              rotation: cog
          };
      if (markerTo != null) {
        markerTo.setPosition(p1);
        markerTo.setIcon(icon);
        mapVectorLabel.set('text', '    ' + sog + 'Kn ' + cog + '\u00B0    ');  
        mapVectorLabel.set('position', p1);  
      } else {
        markerTo = new google.maps.Marker({
          position: p1,
          title: "",
          icon: icon,
          map: map
        });
        mapVectorLabel = new MapLabel({
            text: '    ' + sog + 'Kn ' + cog + '\u00B0    ',
            position: p1,
            map: map,
            fontSize: 20,
            align: 'right'
          });
      }
    }
  }

  function setMarkerWind(p, pW, tw, cog) {
    if (map!=null) {
      if (pW!=null) {
        var icon = {
              path: 'M -5 10 L 0 0 L 5 10Z',
                strokeColor: '#FFFF00',
                fillColor: '#FFFF00',
                fillOpacity: .6,
                anchor: new google.maps.Point(0,0),
                strokeWeight: 3,
                scale: 1,
                rotation: 180 + (tw.angle + cog)
            };
        if (markerWind != null) {
          markerWind.setPosition(pW);
          markerWind.setIcon(icon);
          mapWindLabel.set('text', '    ' + tw.speed.toFixed(1) + 'Kn ' + tw.show_angle.toFixed(0) + '\u00B0 ' + tw.tack + '   ');
          mapWindLabel.set('position', pW);
        } else {
          markerWind = new google.maps.Marker({
            position: pW,
            title: "",
            icon: icon,
            map: map
          });
          mapWindLabel = new MapLabel({
            text: '    ' + tw.speed.toFixed(1) + 'Kn ' + tw.angle.toFixed(0) + '\u00B0    ',
            position: pW,
            map: map,
            fontSize: 20,
            align: 'right'
          });          
        }
      }
    }
  }

  function setMarker(msg, lat, lon, sog, cog) {

    var p = new google.maps.LatLng(lat, lon);
    var p1 = google.maps.geometry.spherical.computeOffset(p, sog * 1852, cog);
    var pW = (trueWind!=null) ? google.maps.geometry.spherical.computeOffset(p, trueWind.speed * 1852, trueWind.angle + cog) : null;

    if (map == null) {
      loadMap(msg, lat, lon);
    }

    if (map != null) {

      setMarkerPos(p, cog, sog);
      setMarkerSpeed(p1, cog, sog);
      setMarkerWind(p, pW, trueWind, cog);

      map.setCenter(p);

      if (poly==null) {
        poly = new google.maps.Polyline({
          strokeColor: '#000000',
          strokeOpacity: 1.0,
          strokeWeight: 3
        });
        poly.getPath().push(p1);
        poly.getPath().push(p);
        poly.setMap(map);
      } else {
        poly.getPath().setAt(0, p1);
        poly.getPath().setAt(1, p);
      }

      if (pW!=null) {
        if (polyWind==null) {
          polyWind = new google.maps.Polyline({
            strokeColor: '#FFFF00',
            strokeOpacity: 1.0,
            strokeWeight: 3
          });
          polyWind.getPath().push(p);
          polyWind.getPath().push(pW);
          polyWind.setMap(map);
        } else {
          polyWind.getPath().setAt(0, p);
          polyWind.getPath().setAt(1, pW);
        }
      }
    }
  }

</script>


<body ng-app="nmearouter">
  <div id="sensorPanel" ng-controller="myCtrl">
    <ol class="breadcrumb">
      <li class="breadcrumb-item"><a href="index.html">Home</a></li>
      <li class="breadcrumb-item active">Sensors</li>
    </ol>

    <div class="panel panel-primary">
      <div class="panel-heading">
        <h2 class="panel-title">Map</h2>
      </div>
      <div class="panel-body">
        <div style="width: 100%; height: 100%; min-height: 864px" id="map"></div>
      </div>
    </div>
  </div>
</body>

</html>